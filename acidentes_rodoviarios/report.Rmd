---
title: "Exploratória - IPEA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
df <- readr::read_csv('ocorrencias_2021.csv')
```

## Dados


## Caracterização dos acidentes de trânsito nas rodovias federais em 2021

Em 2021 ocorreram 64.515 acidentes nas estradas federais fiscalizadas pela PRF, sendo  que 5.395 pessoas perderam a vida e 71.780 ficaram feridos. Pouco mais de um quarto dos feridos teve lesões graves. Nesse ano, cerca de 7% dos acidentes apresentaram vítimas  fatais; 74%, vítimas feridas; e 18% foram acidentes sem vítimas. Aproximadamente 72% dos acidentes com vítimas fatais ocorreram em zonas rurais, e 24% das mortes foram causadas por excesso de velocidade e transitar na contramão.

```{r caracteristicas por classificacao}
tb1 <- df |> 
  group_by(classificacao_acidente) |> 
  summarise(
    Acidentes = n(),
    `Veículos envolvidos` = sum(veiculos),
    Ilesos = sum(ilesos),
    Feridos = sum(feridos),
    Mortos = sum(mortos), .groups = "drop") 

tb1 |> 
  rename(Categoria = classificacao_acidente) |> 
  janitor::adorn_totals() |> 
  knitr::kable()

# porcentagens
tb1 |>  
  mutate(
    across(
      .cols = c(Acidentes, `Veículos envolvidos`, Ilesos, Feridos, Mortos),
      .fns = ~.x / sum(.x) * 100))

# acidentes  com vitimas fatais rural / urbano
## sim = urbano, nao = rural

df |> 
  mutate(uso_solo = case_when(
    uso_solo == 'Sim' ~ 'Urbano',
    uso_solo == 'Nao' ~ 'Rural')) |> 
  filter(classificacao_acidente == "Com vitimas fatais") |> 
  group_by(uso_solo) |> 
  summarise(Acidentes = n(), .groups = "drop") |> 
  mutate(Acidentes = Acidentes / sum(Acidentes) * 100)

# causa acidente - mortes
df |> 
  group_by(causa_acidente) |> 
  summarise(Mortos = sum(mortos), .groups = "drop") |> 
  mutate(Mortos = Mortos / sum(Mortos) * 100) |> 
  arrange(-Mortos)
```
Nesse mesmo ano, ocorreram em média 177 acidentes e houve 14 mortos por dia. Esses acidentes envolveram 106.697 veículos, uma média de 1,65 veículos por ocorrência. O estado de Minas Gerais foi o que apresentou o maior número de acidentes e mortos, enquanto o estado do Amazonas, o menor.

```{r include=FALSE}
# média de acidentes/mortes e veicuos por ocorrencia
df |> 
  summarise(
    qtd_days = as.integer(max(data) - min(data)),
    media_acidentes_day = n() / qtd_days,
    media_mortes_day = sum(mortos) / qtd_days,
    media_veiculos_ocorr = sum(veiculos) / n())

# estados com maior/menor numero de acidentes e mortos
df |> 
  group_by(uf) |> 
  summarise(qtd_acidentes = n()) |>
  ggplot(aes(reorder(uf, qtd_acidentes), qtd_acidentes)) +
  geom_col() +
  labs(x = "Estado", y = NULL) +
  coord_flip() 
```

Considerando a mortalidade por tipo de acidente, verifica-se que a colisão frontal foi responsável por 36,6% das mortes, seguida pelos atropelamentos de pessoas, responsável por 30,9% das mortes. Esses tipos de acidente responderam por 11,2% do total e, embora menos frequentes, foram os mais letais. Nos acidentes do tipo colisão frontal, morreram 36,6 pessoas a cada cem acidentes; e nos do tipo atropelamento de pessoas, 30,8. Chama a atenção também a frequência de colisões traseiras e transversais, que correspondem a 31,5% dos acidentes, que somado ao segundo maior tipo de acidente frequente, saída de leito carrocável, equivalem a quase metade dos acidentes, isto é, uma concentração em tipos de acidentes comuns.	

```{r}
df |> 
  group_by(tipo_acidente) |> 
  summarise(
    Acidentes = n(),
    Feridos = sum(feridos),
    Mortos = sum(mortos),
    `Acidentes Graves` = sum(feridos_graves),
    `Mortes/100 acidentes` = Mortos / Acidentes * 100, .groups = "drop") |>
  mutate(`% Acidentes` = Acidentes / sum(Acidentes) * 100) |> 
  arrange(-`Mortes/100 acidentes`) |> 
  knitr::kable()

df |> 
  group_by(tipo_acidente) |> 
  summarise(
    Acidentes = n(),
    Mortos = sum(mortos), .groups = "drop") |>
  mutate(
    `% Acidentes` = Acidentes / sum(Acidentes) * 100,
    `% Mortos` = Mortos / sum(Mortos) * 100) |>
  slice_max(n = 10, order_by = `% Mortos`) |> 
  tidyr::pivot_longer(
    cols = c(`% Acidentes`, `% Mortos`),
    names_to = "indicador",
    values_to = "pct") |> 
  ggplot(aes(reorder(tipo_acidente, pct), pct, fill = indicador)) + 
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual("", values = c("#3EAEAE", "#32593A")) +
  geom_text(
    aes(reorder(tipo_acidente, pct), label = round(pct, 1), fill = indicador),
    position = position_dodge(width = 1),
    hjust = 0.2, size = 3
  ) + 
  coord_flip() +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  labs(x = NULL, y = NULL,  title = "Tipo versus gravidade dos acidentes nas rodovias federais (2021)")
```

Focando os dois principais tipos de acidente que geram mais óbitos pode-se traçar um perfil dessas ocorrências: 88,88% das colisões frontais ocorreram em pistas simples, ocasionando 93,96% dos mortos nesse tipo de acidente; além disso, 70% das colisões ocorreram em trechos rurais, que ocasionou 86% dos mortos nesse tipo. Em ambos tipos de acidente, mais de 88% das ocorrências e mortes aconteceram nos períodos *plenos* - dia e noite. 

```{r}
# tipo pista
df |> 
  filter(tipo_acidente %in% c("Colisao frontal", "Atropelamento de pedestre")) |> 
  group_by(tipo_acidente, tipo_pista) |> 
  summarise(qtd_acc = n(), qtd_mortos = sum(mortos)) |> 
  mutate(
    pct_acc = qtd_acc / sum(qtd_acc) * 100,
    pct_mortos = qtd_mortos / sum(qtd_mortos) * 100) |>
  select(tipo_acidente, tipo_pista, starts_with("pct"))

# rural ou urbano
df |> 
  filter(tipo_acidente %in% c("Colisao frontal", "Atropelamento de pedestre")) |> 
  mutate(uso_solo = case_when(
    uso_solo == 'Sim' ~ 'Urbano',
    uso_solo == 'Nao' ~ 'Rural')) |> 
  group_by(tipo_acidente, uso_solo) |> 
  summarise(qtd_acc = n(), qtd_mortos = sum(mortos)) |> 
  mutate(
    pct_acc = qtd_acc / sum(qtd_acc) * 100,
    pct_mortos = qtd_mortos / sum(qtd_mortos) * 100) |>
  select(tipo_acidente, uso_solo, starts_with("pct"))

# periodo do dia
df |> 
  filter(tipo_acidente %in% c("Colisao frontal", "Atropelamento de pedestre")) |> 
  group_by(tipo_acidente, fase_dia) |> 
  summarise(qtd_acc = n(), qtd_mortos = sum(mortos)) |> 
  mutate(
    pct_acc = qtd_acc / sum(qtd_acc) * 100,
    pct_mortos = qtd_mortos / sum(qtd_mortos) * 100) |>
  select(tipo_acidente, fase_dia, starts_with("pct"))
```

Em relação aos atropelamentos, esses eventos ocorrem com bastante frequência nas rodovias federais. Em 2021 houve 2.909 acidentes com atropelamento, com 898 mortes e 1.258 feridos graves. Os estados de Paraná, Minas Gerais, São Paulo e Rio de Janeiro registraram 41% dos pedestres mortos em acidentes. Além disso, ainda nesse tipo de acidente, destaca-se:

- 31,48% dos acidentes e 36,63% das mortes ocorreram no fim de semana (sábado e domingo), 46,8% das ocorrências foram entre 18h e 21h
- 74% dos acidentes e mortes ocorreram em vias retas
- A BR-116 e a BR-101 são responsáveis por 38,53% das ocorrências de atropelamento de pessoas

```{r}
# qtd acidentes, mortos, feridos
df |> 
  filter(tipo_acidente == "Atropelamento de pedestre") |> 
  summarise(
    qtd_acidentes = n(),
    qtd_mortos = sum(mortos),
    qtd_feridos_leves = sum(feridos_leves),
    qtd_feridos_graves = sum(feridos_graves))

# por uf
(tb2 <- df |> 
  filter(tipo_acidente == "Atropelamento de pedestre") |> 
  group_by(uf) |> 
  summarise(
    qtd_acidentes = n(),
    qtd_mortos = sum(mortos),
    qtd_feridos_leves = sum(feridos_leves),
    qtd_feridos_graves = sum(feridos_graves), .groups = "drop") |>
  mutate(
    pct_acidentes = qtd_acidentes / sum(qtd_acidentes) * 100,
    pct_mortos = qtd_mortos / sum(qtd_mortos) * 100) |> 
  slice_max(n = 20, order_by = pct_acidentes) )

## grafico por uf
tb2 |> 
  tidyr::pivot_longer(
    cols = c(pct_acidentes, pct_mortos),
    names_to = "pct",
    values_to = "pct_values") |> 
  ggplot(aes(uf, pct_values, fill = pct)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip()

# explorando mortes por atropelamento
atropelamento_by_x <- function(.col) {
  df |> 
    filter(tipo_acidente == "Atropelamento de pedestre") |> 
    group_by({{.col}}) |> 
    summarise(qtd_acc = n(), qtd_mortos = sum(mortos), .groups = "drop") |>
    mutate(
      pct_acc = qtd_acc / sum(qtd_acc) * 100,
      pct_mortos = qtd_mortos / sum(qtd_mortos) * 100)
}


## dia_semana
atropelamento_by_x(dia_semana)

## hora
atropelamento_by_x(hora) |> 
  rename(`Acidentes`= pct_acc, `Mortos` = pct_mortos) |> 
  tidyr::pivot_longer(
    Acidentes:Mortos,
    names_to = "pct_type",
    values_to = "pct_values") |> 
  mutate(hora = as.integer(hora)) |> 
  ggplot(aes(hora, pct_values, color = pct_type)) +
  geom_line(size = 1.3) +
  geom_label(aes(label = round(pct_values, 1)), nudge_x = 0.35, size = 4, show.legend = FALSE) +
  scale_color_manual("", values = c("#3EAEAE", "#32593A")) +
  scale_x_continuous(breaks = 0:23) +
  geom_vline(xintercept = 17, color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = 22, color = "red", size = 1, linetype = "dashed") +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  labs(x = NULL, y = "%", title = "% de acidentes e mortos por atropelamentos por hora do dia (2021)")
  

## classificacao_acidente
atropelamento_by_x(classificacao_acidente)

## tipo pista
atropelamento_by_x(tracado_via)

## br
atropelamento_by_x(br)
```

## Estatísticas dos acidentes de trânsito nas rodovias federais (anos)

```{r}
df |>
  group_by(ano) |> 
  summarise(
    `Total de acidentes` = n(),
    `Número de veículos envolvidos` = sum(veiculos),
    `Número de mortes` = sum(mortos),
    `Mortes/1.000 acidentes` =  sum(mortos) / n() * 1000,
    `Número de acidentes/morte` = n() / sum(mortos),
    `Número de feridos` = sum(feridos),
    `Feridos/1.000 acidentes` = sum(feridos) / n() * 1000,
    `Número de acidentes/ferido` = n() / sum(feridos),
    `Número de ilesos` = sum(ilesos),
    `Ilesos/1.000 acidentes` = sum(ilesos) / n() * 1000,
    `Número de acidentes/ileso` = n() / sum(ilesos)) |> 
  tidyr::pivot_longer(
    cols = -ano,
    names_to = "Item",
    values_to = "value") |> 
  tidyr::pivot_wider(names_from = ano)
  
```






